<!DOCTYPE html>
<html class="no-js" lang="ko-kr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>KVM 스터디(with go) - ShrinkLabs</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="ShrinkLabs" rel="home">
				<div class="logo__title">ShrinkLabs</div>
				<div class="logo__tagline">컨테이너 관리 솔루션을 만들면서 작성하는 작업 일지</div>
			</a>
		</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">KVM 스터디(with go)</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2017-12-02T23:55:52&#43;09:00">December 02, 2017</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/kvm/" rel="category">kvm</a>
	</span>
</div></div>
		</header><div class="content post__content clearfix">
			

<p>주의, 이 글은 KVM이 뭔지도 제대로 모르면서 학습한 내용을 정리한거라서, 정확하지 않은 내용이 다수 포함되어 있을 수 있습니다.<br />
틀린 내용은 지적해 주시면 수정해서 반영하도록 하겠습니다.</p>

<h2 id="준비물">준비물</h2>

<p>노트북(우분투 16.04)</p>

<h2 id="kvm이-뭔가요">KVM이 뭔가요?</h2>

<h3 id="하이퍼바이저">하이퍼바이저?</h3>

<p>위키백과에 나와 있는 정의( <a href="https://ko.wikipedia.org/wiki/%ED%95%98%EC%9D%B4%ED%8D%BC%EB%B0%94%EC%9D%B4%EC%A0%80">https://ko.wikipedia.org/wiki/%ED%95%98%EC%9D%B4%ED%8D%BC%EB%B0%94%EC%9D%B4%EC%A0%80</a> ) 를 보면 이렇게 나와 있다.</p>

<p>&ldquo;다수의 운영 체제를 동시에 실행하기 위한 논리적 플랫폼&rdquo;</p>

<p>여기에 우리가 잘 알고 있는 VmWare, VirtualBox와 같은것도 있고, Xen, KVM 같이 좀 낯선 것들도 있다.</p>

<p>내용을 읽다보면, 왠지 중요해 보이는 단어 Type1, Type2, 전가상화, 반가상화 뭐 이런 단어들이 나온다.<br />
Type1은 호스트에 하이퍼바이저가 존재하고, Type2는 호스트 OS에 설치된 응용 프로그램 형태로 하이퍼바이저가 존재하는거라고 보면 될 거같다.<br />
그리고 전/반 가상화는 게스트에서 하이퍼바이저에 어떤 방식으로 접근을 하는지에 대한 구분 정도로 보면 어떨까 싶다&hellip;;<br />
전가상화는 게스트OS가 본인이 가상화된 상태라는걸 모르게 모든 하드웨어가 가상화 되어 제공되는 상태이며, 반가상화는 게스트 OS가 가상화되고 있음을 인지하고 특정한 하드웨어를 사용하기 위해서 게스트 OS의 커널의 변경이 필요한 상태이다.<br />
전가상화와 반가상화에 대해서 가장 이해하기 쉽게 설명된 글을 참고해보면 좋을것 같다. ( <a href="https://knowcitrixx.wordpress.com/2014/11/12/hypervisor-full-para-virtualization/">https://knowcitrixx.wordpress.com/2014/11/12/hypervisor-full-para-virtualization/</a> )</p>

<p>이건 공부하면서 이런거 같다라고 정리한 내용이니 100% 믿지는 말기 바란다.</p>

<p>이 글에서는 여러가지의 하이퍼바이저들 중에서 KVM(Kernel-based Virtual Machine)을 사용해 보려고 한다.</p>

<h3 id="어떻게-쓰는거지">어떻게 쓰는거지?</h3>

<h4 id="설치와-vm-생성">설치와 VM 생성</h4>

<p>우리는 QEMU(KVM) 이라는 하이퍼바이저를 설치할거다.<br />
우선 현재 CPU가 가상화를 지원하는지 확인을 해야한다.</p>

<pre><code>$ egrep -c ‘(vmx|svm)’ /proc/cpuinfo
</code></pre>

<p>결과가 1보다 크면 가상화를 지원하는 CPU 이다.<br />
그럼 KVM 관련 패키지들을 설치해 보자.<br />
설치하기전에 os관련 업데이트를 하자.</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get upgrade
</code></pre>

<p>이제 진짜로 설치&hellip; qemu-kvm을 설치한다.<br />
qemu-kvm은 qemu/kvm을 관리할 수 있는 기본적인 프로그램들이 설치된다.</p>

<pre><code>$ sudo apt install qemu-kvm
</code></pre>

<p>뭔가 한참을 설치한다.</p>

<p>설치된 항목들은 확인 하기 위해서 터미널창에서 qemu까지 입력하고 탭을 몇 번 입력해보자.<br />
qemu로 시작하는 command가 몇 개가 보여질거다.<br />
qemu-img(qemu의 디스크 이미지 관리를 위한 명령어),<br />
qemu-io(qemu용 저장 장치를 위한 진단, 조작 프로그램),<br />
qemu-make-debian-root(데비안 루트 이미지를 생성),<br />
qemu-nbd(network block device: 호스트의 블록 디바이스에 연결하여 사용하는 장치, qemu 이미지를 자체적으로 제공하도록 한다.)<br />
qemu-system-i386, qemu-system-x86_64, qemu-system-x86_64-spice(qemu pc 시스템 에뮬레이터)<br />
그리고 kv까지 입력하고 탭을 몇 번 입력해 보면 kvm으로 시작하는 command가 몇 개 보인다.<br />
kvm, kvm-ok, kvm-spice</p>

<p>마지막으로 vir까지 입력하고 탭을 몇 번 입력해 보면,<br />
virtfs-proxy-helper<br />
가 보인다.</p>

<p>이제 KVM이 설치되었는지 확인을 해보자.</p>

<pre><code>$ lsmod | grep kvm
</code></pre>

<p>을 하면 &hellip;</p>

<pre><code>kvm_intel    192512    0
kvm        598016    1    kvm_intel
irqbypass    16384        1    kvm
</code></pre>

<p>위의 결과와 비슷한 화면이 보인다. 그럼 잘 설치 된거다.</p>

<p>그럼 이제 VM을 생성해보자.</p>

<p>우선 ubuntu 이미지를 하나 받아 놓자.<br />
( <a href="https://help.ubuntu.com/community/Installation/MinimalCD">https://help.ubuntu.com/community/Installation/MinimalCD</a> )</p>

<pre><code>$ wget http://archive.ubuntu.com/ubuntu/dists/xenial/main/installer-amd64/current/images/netboot/mini.iso
</code></pre>

<p>그리고 qemu-img로 디스크를 미리 만들어 놓는다.</p>

<pre><code>$ qemu-img create ubuntu.qcow2 10G
</code></pre>

<p>생성한 디스크에 os 설치를 한다.</p>

<pre><code>$ qemu-system-x86_64 -localtime -net  user -net nic -m 256 -cdrom mini.iso -hda ubuntu.qcow2 -boot d
</code></pre>

<p><img src="https://docs.google.com/drawings/d/e/2PACX-1vTy6mMJx7hrjFbQVHYBYohYI4Fh3G4kAYDy4XggeWHbZL65NdhBUNNZy3rYSPXWforAfTXm2I4lOKIl/pub?w=603&amp;h=474" alt="" /></p>

<p>이렇게 kvm을 이용해서 가상머신상에 ubuntu를 설치해 봤다.</p>

<h2 id="go언어는-뭐죠">Go언어는 뭐죠?</h2>

<h3 id="go언어란">Go언어란?</h3>

<p>Go언어에 대한 정의도 위키백과를 참고해 보자.( <a href="https://ko.wikipedia.org/wiki/Go_(%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D_%EC%96%B8%EC%96%B4">https://ko.wikipedia.org/wiki/Go_(%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D_%EC%96%B8%EC%96%B4</a>) )
구글에서 유명한 아저씨들(로버트 그리즈머, 롭 파이크, 켄 톰슨)이 만들기 시작했다.<br />
2009년 11월에 세상에 공개가 되었다.</p>

<p>문법은 C랑 비슷하고&hellip;(라고 하지만 Go 코드에 익숙해지고 난 다음에 C코드 보면 정말 헷갈린다..;)</p>

<p>여러가지 편리한 도구들도 제공한다.<br />
go build<br />
go test<br />
go fmt<br />
go get<br />
go vet<br />
go run<br />
godoc<br />
gorename<br />
go generate</p>

<h3 id="그래서">그래서?</h3>

<h4 id="설치">설치</h4>

<p>설치는 다음과 같이 하면 된다.</p>

<ol>
<li><p>기존에 설치된 버전이 있다면 삭제한다.</p>

<pre><code>$ rm -r /usr/local/go
</code></pre></li>

<li><p><a href="http://golang.org/doc/install">http://golang.org/doc/install</a> 에서 다운로드
(또는$ wget –no-check-certificate <a href="https://storage.googleapis.com/golang/go1.7.1.linux-amd64.tar.gz">https://storage.googleapis.com/golang/go1.7.1.linux-amd64.tar.gz</a> 와 같이 원하는 OS 및 버전에 맞는 Go 바이너리를 wget으로 받을 수도 있다.)</p></li>

<li><p>/usr/local/go에 압축을 푼다.</p>

<pre><code>$ sudo tar -C /usr/local -xzf gox.x.x.linux-xxx.tar.gz
</code></pre></li>

<li><p>$HOME/.profile 에 다음을 추가한다.</p>

<pre><code>PATH=$PATH:/usr/local/go/bin  
</code></pre>

<pre><code>GOPATH=$HOME/work
</code></pre></li>

<li><p>.profile을 적용한다.</p>

<pre><code>$ source ./.profile
</code></pre></li>

<li><p>설치가 되었으면 제대로 설치되었는지 확인 해보자.</p>

<pre><code>$ go version
</code></pre></li>

<li><p>결과가 다음이랑 비슷하게 나오면 성공한거다.</p>

<pre><code>go version go1.8.1 linux/amd64
</code></pre></li>
</ol>

<h4 id="hello-world">Hello,World</h4>

<p>이제 Hello, World 한번 찍어보자.</p>

<ol>
<li><p>에디터(utf-8 편집 가능한걸로)로 다음과 같이,</p>

<pre><code class="language-go">package main

import “fmt”

func main() {
    fmt.Println(“Hello, World”)
}
</code></pre></li>
</ol>

<p>main.go 파일을 하나 만들어서 작성해보자.
2. 이제 저장하고 빌드해보자.</p>

<pre><code>   $ go run main.go
   $ go build
   $ go install
</code></pre>

<p>빌드하는 방법은 위와 같이 3가지가 있는데, run은 결과물을 굳이 만들지 않고 결과를 바로 확인 할 수 있는거, build는 현재 작업하고 있는 경로에 결과물을 만들어 놓는거다. 그리고 install은 만들어진 결과물을 $GOPATH의 bin 디렉토리 아래에 옮겨주기까지 한다.<br />
3. 결과를 확인한다.</p>

<h2 id="libvirt는-또-뭐에요">libvirt는 또 뭐에요?</h2>

<h3 id="뭐하는거">뭐하는거?</h3>

<p>KVM같은 하이퍼바이저를 관리(?)를 하기 위한 라이브러리 정도(?)</p>

<h3 id="이건-또-어떻게-쓰나요">이건 또 어떻게 쓰나요?</h3>

<p>우선 설치를 해보자.</p>

<pre><code>$ sudo apt install libvirt-bin ubuntu-vm-builder bridge-utils
</code></pre>

<p>여기에서 libvirt-bin 은 libvirt 관련한 것들(virsh, virt-admin, virt-host-validate, virt-login-shell, virt-pki-validate, virt-xml-validate, virtlockd, virtlogd)이 설치된다. 그리고 /var/lib/libvirt라는 디렉토리가 생긴다.<br />
ubuntu-vm-builder는 깨끗한 테스트환경, 가상 시스템 설치 프로세스를 자동화하거나 하는 VM을 빠르게 만들어 주는게 설치된다고 하는데 뭐가 설치되는지는 아직 잘 모르겠다.<br />
그리고 bridge-utils는 브릿지 네트워크를 설정하기 위한 용도의 무언가가 설치된다고 하는데, 설치되는게 없는거 같다.</p>

<p>KVM에 대한 사용 권한은 루트 사용자와 현재 사용자만이 갖게 된다.<br />
다른 계정을 추가하기 위해서는 다음과 같이 추가한다.</p>

<pre><code>$ adduser user1 libvirtd
</code></pre>

<p>이제 virsh 이라는 libvirt를 다루기 위한 쉘 프로그램이 추가 되어 있는걸 확인 할 수 있다.<br />
이게 나중에  유용하게 사용이 될 거다.</p>

<p>그리고 이제는 virt-manager라는 GUI기반의 VM 관리 도구를 설치한다.</p>

<pre><code>$ sudo apt install virt-manager
</code></pre>

<p>virt-manager를 설치하게 되면 virt-install, virt-viewer, virt-clone, virt-xml, virt-convert 같은걸 추가로 사용할 수 있게된다.</p>

<p>virt-manager를 설치하지 않고 virtinst 를 설치해도 가능할거다…;</p>

<p>이제 virt-manager를 사용해서 vm을 생성하고 시작하고 등등의 관리를 GUI 상에서 할 수 있는데, 동일한 작업을 virsh에서 해보기도 하고&hellip;virsh로 해본걸 다시 코드로 작성해 보기도 하자.</p>

<p>libvirt-go 패키지를 설치한다.<br />
우선 libvirt-dev 라이브러리의 설치가 필요하다.</p>

<pre><code>$ sudo apt-get install libvirt-dev
</code></pre>

<p>그리고</p>

<pre><code>$go get github.com/libvirt/libvirt-go
</code></pre>

<p>이제 libvirt-go 패키지까지 설치를 마쳤다.</p>

<h2 id="그럼-이제-뭘-하면-되죠">그럼 이제 뭘 하면 되죠?</h2>

<h3 id="todo-libvirt-go를-사용한-예제들">TODO(libvirt-go를 사용한 예제들)</h3>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/kvm/" rel="tag">kvm</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="ShrinkLabs avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About ShrinkLabs</span>
	</div>
	<div class="authorbox__description">
		Distributed Systems, Containers and ...
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/posts/core/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">core파일 만들기</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/posts/writing-a-unit-test/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Go언어 프로젝트에서 테스트 코드 작성 경험</p></a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Info</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/shrinklabs" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:shrinklabs@gmail.com">
				<svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>shrinklabs@gmail.com</span>
			</a>
		</div>

		
	</div>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/private-container-registry/">Kubernetes에서 Private Container Registry 사용</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/docker-error/">docker 설치 후 에러</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/k8s-with-kops-on-gce/">GCE에서 kops를 이용한 K8s 구성</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/docker-image/">docker image 저장소 위치 변경</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/nginx-ingress-controller-on-google-kubernetes-engine/">10.Nginx Ingress Controller on Google Kubernetes Engine</a></li>
		</ul>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 ShrinkLabs.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>