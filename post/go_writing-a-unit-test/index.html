<!DOCTYPE html>
<html lang="en">
  <head>
  	<meta charset="utf-8">
  	<meta name="viewport"    content="width=device-width, initial-scale=1.0">
  	<meta name="description" content="">
  	<meta name="author"      content="map[]">
    
    	<title>Go언어 프로젝트에서 테스트 코드 작성 경험</title>
	<link rel="shortcut icon" href="https://shrinklabs.com/post/images/favicon.ico">

	
	<link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.no-icons.min.css" rel="stylesheet">
	
	
	<script defer src="https://use.fontawesome.com/releases/v5.0.11/js/all.js" integrity="sha384-ImVoB8Er8knetgQakxuBS4G3RSkyD8IZVVQCAnmRJrDwqJFYUE4YOv+DbIofcO9C" crossorigin="anonymous"></script>
	
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alice|Open+Sans:400,300,700">
	
	
  
  <link rel="stylesheet" href="https://shrinklabs.com/post/css/styles.min.16be9015b1d15d94201894c956885e507505d7b2f836db72cf9bb664b89c63ac6f9b7de5b6d4671478edb138a9c227c4c4e6619e22ef55bd586fa93fb6eed058.css" integrity="sha512-Fr6QFbHRXZQgGJTJVoheUHUF17L4Nttyz5u2ZLicY6xvm33lttRnFHjtsTipwifExOZhniLvVb1Yb6k/tu7QWA==">

   
  

  </head>
  
  <body class="home">

    
      <header id="header">
  <div id="head" class="parallax" data-parallax-speed="2" style="background-image:url('https://shrinklabs.com/post/images/bg_head.jpg');">
    <h1 id="logo" class="text-center">
      <img class='img-circle' src="https://shrinklabs.com/post/images/logo.png" alt="">
      <span class="title"></span>
      <span class="tagline"><br>
        <a href="mailto:"></a>
      </span>
   </h1>
</div>

<nav class="navbar navbar-default navbar-sticky">
    <div class="container-fluid">

        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="true">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <div class="navbar-collapse collapse" id="bs-example-navbar-collapse-1">

            <ul class="nav navbar-nav">
            
            </ul>

        </div> 
        
    </div>
</nav>

</header>
    
 
    
<main id="main">

	<div class="container">

		<div class="row topspace">
			<div class="col-sm-8 col-sm-offset-2">

 				<article class="post">
					<header class="entry-header">
 						<div class="entry-meta">
               <span class="posted-on">
                  <time class="entry-date published" datetime="February 21, 2018">February 21, 2018</time>
               </span>
 						</div>
 						<h1 class="entry-title"><a href="https://shrinklabs.com/post/post/go_writing-a-unit-test/" rel="bookmark">Go언어 프로젝트에서 테스트 코드 작성 경험</a></h1>
					</header>
					<div class="entry-content">
						<h2 id="테스트-코드는-왜">테스트 코드는 왜?</h2>
<p>현재 프로젝트를 진행 중 코딩을 할 때면 계속해서 의심과 두려움이 들었다.</p>
<p>&ldquo;내가 제대로 작성하고 있는 게 맞나?&rdquo;<br>
&ldquo;이렇게 작성하면 다른 데에서 문제가 생기는 건 아닌가?&rdquo;</p>
<p>그리고 이런 걱정들은 다음의 2가지 원인 때문이지 않을까 라고 생각하게 되었다.<br>
첫 번째, 코드 작성 후 실행해서 결과를 확인하기 위해서 개인 개발 환경을 MessageQueue와 내가 보낸 요청에 대해 기대하는 응답을 전달해줄 MessageQueue 반대편의 모듈을 구성하기가 쉽지 않다는 것이었다.<br>
두 번째, 기존에 코딩하면서 세워 놓았던 원칙을 기억하지 못하고 그 원칙에 어긋나는 코드를 작성하게 되었을 때, 전체 시스템에서 동작 중 알 수 없는 순간에 오동작하는 경우 때문이었다.</p>
<p>&ldquo;테스트 주도 개발 TDD 실천법과 도구&rdquo; 라는 책과 함께 몇 가지의 블로그 포스팅 그리고 몇 권의 책을 더 읽어 보면서 테스트 코드를 작성해 보면 문제의 원인을 해결할 수 있지 않을까 싶었다.<br>
그래서 진행중인 프로젝트들에 테스트 코드를 작성해 보기로 했다.</p>
<h2 id="테스트-코드는-뭘">테스트 코드는 뭘?</h2>
<p>테스트 코드를 작성할 때에 주의해야 할 점은 다음과 같다.</p>
<ol>
<li>&ldquo;질문 -&gt; 응답 -&gt; 정제 -&gt; 반복&rdquo; 의 과정을 거쳐서, 테스트를 작성하고 실패하고 정리하고  이걸 반복한다.</li>
<li>테스트 작성의 최소 단위는 함수이다. 하나의 함수를 기준으로 테스트 코드를 작성할 수 있다.</li>
<li>설계할 때 동작을 먼저 정의하고 그 동작에 필요한 속성을 고려한다.</li>
</ol>
<h2 id="테스트-코드는-어떻게">테스트 코드는 어떻게?</h2>
<p>Go 언어에서 테스트 코드의 작성은 표준으로 제공하는 “testing” 패키지만으로 가능합니다.</p>
<p>테스트 코드 작성과 확인을 좀 더 편리하게 도와주는 다음과 같은 도구들의 도움을 받을 수도 있습니다.</p>
<ul>
<li>testify ( go get -u github.com/stretchr/testify )</li>
<li>goconvey ( go get -u github.com/smartystreets/goconvey )</li>
</ul>
<p>testify는 assert, http, mock, require, suite 와 같은 패키지를 제공해서 좀 더 편리한 검증을 할 수 있도록 도와 줍니다. 그리고 goconvey는 터미널(go test)에서 테스트 결과를 확인하던걸 브라우저에서 편리하게 확인할 수 있게 해주는 도구입니다.</p>
<p>goconvey의 사용은 테스트를 진행할 디렉토리에서 goconvey를 실행해 주면 웹브라우저가 실행되면서 다음과 같은 화면으로 현재 프로젝트의 테스트 상황을 한 눈에 볼 수 있게 해줍니다.<br>
<img src="/image/writing-a-unit-test/scr-1.png" alt=""></p>
<p>또한, 현재 coverage 상태를 다음과 같이 볼 수도 있습니다.<br>
<img src="/image/writing-a-unit-test/scr-2.png" alt=""></p>
<h2 id="테스트-코드-작성">테스트 코드 작성</h2>
<p>테스트 함수 작성 요령</p>
<ul>
<li>
<p>테스트 대상 함수와 이름을 1:1로 일치 시킵니다.</p>
<pre><code>대상: Getbalance() {...}  
테스트: TestGetbalance(...) {...}
</code></pre></li>
<li>
<p>테스트 대상 메소드의 이름을 메소드 단위로 작성을 하면서 뒤에 추가적인 케이스에 대한 내용을 추가합니다.</p>
<pre><code>func Test_Withdraw_마이너스통장인출(...) {...}
</code></pre></li>
<li>
<p>특정한 메소드가 아닌 테스트 시나리오를 대상으로 하는 테스트 메소드를 작성하는 경우도 있습니다.</p>
<pre><code>func Test_VIP고객이_인출할때_수수료계산(...) {...}
</code></pre></li>
<li>
<p>테스트 케이스 시나리오는 정상적인 흐름에 대한 결과를 확인하거나, 예외나 에러 상황에 대한 결과를 확인하는 방법이 있을 수 있습니다. 그리고 a+b의 동작을 하는 메소드에 a와 b를 넣고 실제로 a+b를 한 결과와 일치하는지 확인해 보는 식의 경우가 있습니다.</p>
</li>
</ul>
<p>Go 언어로 만들어진 프로젝트에서 테스트 코드를 작성하기 위해서는 몇 가지 규칙이 있습니다.</p>
<ul>
<li>
<p>파일명이 &ldquo;xxx_test.go&rdquo; 와 같이 파일명 뒤에 _test라고 지정합니다.</p>
</li>
<li>
<p>테스트를 진행할 함수의 이름은 &ldquo;Test&rdquo; 로 시작되어야 합니다.</p>
<pre><code>func Test_Minus_작은_수에서_큰_수_빼기(t *testing.T) { }
</code></pre></li>
<li>
<p>위의 ex에서 보이는 것 처럼 testing.T 를 인자로 받습니다. testing.T 타입은 Error, Fail, Fatal, Log 등과 같은 테스트에 필요한 요소들을 갖고 있습니다.
(자세한 내용은 <a href="https://golang.org/pkg/testing/">https://golang.org/pkg/testing/</a> 을 참고)</p>
</li>
</ul>
<h2 id="테스트-코드-작성-예1">테스트 코드 작성 예(1)</h2>
<p>간단한 더하기 계산을 하는 패키지를 만들면서 필요한  테스트 코드를 작성하는 예를 한번 보겠습니다.<br>
테스트 코드는 다음과 같습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// add_test.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">add</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestAdd</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">//arrange
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">res</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">x</span> = <span style="color:#ae81ff">2</span>
	<span style="color:#a6e22e">y</span> = <span style="color:#ae81ff">3</span>

	<span style="color:#75715e">//act
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">res</span> = <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>)

	<span style="color:#75715e">//assert
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Add의 결과가 옳바르지 않습니다&#34;</span>)
	}
}
</code></pre></div><p>add 패키지의 구현은 다음과 같습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// add.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">add</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">y</span>
}
</code></pre></div><p>이제 테스트를 진행해서 결과를 보기 위해서 다음과 같이 실행합니다.</p>
<pre><code>$ go test -v
=== RUN   TestAdd
--- PASS: TestAdd (0.00s)
</code></pre><h2 id="테스트-코드-작성-예2">테스트 코드 작성 예(2)</h2>
<p>이번에는 testify/assert 패키지를 이용한 테스트 코드 작성 예를 한번 보도록 하겠습니다. 그리고 현재 프로젝트 디렉토리에서 goconvey를 실행해서 브라우저를 통해서 테스트 함수들의 성공 또는 실패를 계속해서 확인해겠습니다.</p>
<pre><code>sample_1$ goconvey

2018/02/20 17:02:39 goconvey.go:61: Initial configuration: [host: 127.0.0.1] [port: 8080] [poll: 250ms] [cover: true]
2018/02/20 17:02:42 tester.go:19: Now configured to test 10 packages concurrently.
2018/02/20 17:02:42 goconvey.go:192: Serving HTTP at: http://127.0.0.1:8080
2018/02/20 17:02:42 integration.go:122: File system state modified, publishing current folders... 0 3038222316
2018/02/20 17:02:42 goconvey.go:118: Received request from watcher to execute tests...
2018/02/20 17:02:42 executor.go:69: Executor status: 'executing'
2018/02/20 17:02:42 coordinator.go:46: Executing concurrent tests: sample_1
2018/02/20 17:02:42 goconvey.go:105: Launching browser on 127.0.0.1:8080
2018/02/20 17:02:46 goconvey.go:113: ATTENTION: default value of option force_s3tc_enable overridden by environment.
기존 브라우저 세션에 새 창을 생성했습니다.
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// oprcfg.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CfgItem</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Name</span>        <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">Value</span>       <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">Owner</span>       <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Cfg</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#a6e22e">CfgItem</span>
}
 
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConfig</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">Config</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">oc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Config</span>{}
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">Cfg</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#a6e22e">CfgItem</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">oc</span>, <span style="color:#66d9ef">nil</span>
}
 
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">oc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Config</span>) <span style="color:#a6e22e">GetOprCfg</span>(<span style="color:#a6e22e">owner</span> <span style="color:#66d9ef">string</span>) []<span style="color:#a6e22e">OprCfg</span> {
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">owner</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
  }
  
  <span style="color:#a6e22e">globalCategory</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;global&#34;</span>
  <span style="color:#a6e22e">srchCategory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">owner</span>
 
  <span style="color:#a6e22e">globalConfigItem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">Cfg</span>[<span style="color:#a6e22e">globalCategory</span>]
  <span style="color:#a6e22e">srchConfigItem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">Cfg</span>[<span style="color:#a6e22e">srchCategory</span>]
 
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resOpcf</span> []<span style="color:#a6e22e">OprCfg</span>
 
  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">cf</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">globalConfigItem</span> {
    <span style="color:#a6e22e">opcf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">OprCfg</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">cf</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">cf</span>.<span style="color:#a6e22e">Value</span>, <span style="color:#a6e22e">Owner</span>: <span style="color:#a6e22e">cf</span>.<span style="color:#a6e22e">Owner</span>}
    <span style="color:#a6e22e">resOpcf</span> = append(<span style="color:#a6e22e">resOpcf</span>, <span style="color:#a6e22e">opcf</span>)
  }
 
  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">cf</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">srchConfigItem</span> {
    <span style="color:#a6e22e">opcf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">OprCfg</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">cf</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">cf</span>.<span style="color:#a6e22e">Value</span>, <span style="color:#a6e22e">Owner</span>: <span style="color:#a6e22e">cf</span>.<span style="color:#a6e22e">Owner</span>}
    <span style="color:#a6e22e">resOpcf</span> = append(<span style="color:#a6e22e">resOpcf</span>, <span style="color:#a6e22e">opcf</span>)
  }
 
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resOpcf</span>
}
</code></pre></div><p>Config 객체를 생성하는 NewConfig() 함수가 있고, Config에서 owner에 해당하는 OprCfg를 반환하는 GetOprCfg() 함수가 있습니다.<br>
이 두 함수에 대한 테스트 코드를 다음과 같이 작성했습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// oprcfg_test.go
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Test_Config_New</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
  <span style="color:#75715e">// arrange
</span><span style="color:#75715e"></span> 
  <span style="color:#75715e">// act
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">oc</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConfig</span>()
 
  <span style="color:#75715e">// assert
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">NotNil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">oc</span>)
}
 
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Test_GetOprCfg</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
  <span style="color:#75715e">// arrange
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">oc</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConfig</span>()
 
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key1&#34;</span>, <span style="color:#e6db74">&#34;value1&#34;</span>, <span style="color:#e6db74">&#34;key1-value1&#34;</span>, <span style="color:#e6db74">&#34;owner1&#34;</span>)
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key2&#34;</span>, <span style="color:#e6db74">&#34;value2&#34;</span>, <span style="color:#e6db74">&#34;key2-value2&#34;</span>, <span style="color:#e6db74">&#34;owner2&#34;</span>)
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key3&#34;</span>, <span style="color:#e6db74">&#34;value3&#34;</span>, <span style="color:#e6db74">&#34;key3-value3&#34;</span>, <span style="color:#e6db74">&#34;owner1&#34;</span>)
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key4&#34;</span>, <span style="color:#e6db74">&#34;value4&#34;</span>, <span style="color:#e6db74">&#34;key4-value4&#34;</span>, <span style="color:#e6db74">&#34;owner1&#34;</span>)
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key5&#34;</span>, <span style="color:#e6db74">&#34;value5&#34;</span>, <span style="color:#e6db74">&#34;key5-value5&#34;</span>, <span style="color:#e6db74">&#34;owner2&#34;</span>)
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key6&#34;</span>, <span style="color:#e6db74">&#34;value6&#34;</span>, <span style="color:#e6db74">&#34;key6-value6&#34;</span>, <span style="color:#e6db74">&#34;owner3&#34;</span>)
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key7&#34;</span>, <span style="color:#e6db74">&#34;value7&#34;</span>, <span style="color:#e6db74">&#34;key7-value7&#34;</span>, <span style="color:#e6db74">&#34;owner1&#34;</span>)
  <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">SetCfgItem</span>(<span style="color:#e6db74">&#34;key8&#34;</span>, <span style="color:#e6db74">&#34;value8&#34;</span>, <span style="color:#e6db74">&#34;key8-value8&#34;</span>, <span style="color:#e6db74">&#34;global&#34;</span>)
 
  <span style="color:#75715e">// act
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">opcfs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oc</span>.<span style="color:#a6e22e">GetOprCfg</span>(<span style="color:#e6db74">&#34;owner1&#34;</span>)
  <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">opcfs</span>)
 
  <span style="color:#75715e">// assert
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">res</span> []<span style="color:#a6e22e">OprCfg</span>
  <span style="color:#a6e22e">res</span> = make([]<span style="color:#a6e22e">OprCfg</span>, <span style="color:#ae81ff">5</span>)
 
  <span style="color:#75715e">// res에는 global이 먼저 쌓이고, 타겟 owner가 쌓인다
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">res</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#a6e22e">OprCfg</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;key8&#34;</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#e6db74">&#34;value8&#34;</span>, <span style="color:#a6e22e">Owner</span>: <span style="color:#e6db74">&#34;global&#34;</span>}
  <span style="color:#a6e22e">res</span>[<span style="color:#ae81ff">1</span>] = <span style="color:#a6e22e">OprCfg</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;key1&#34;</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#e6db74">&#34;value1&#34;</span>, <span style="color:#a6e22e">Owner</span>: <span style="color:#e6db74">&#34;owner1&#34;</span>}
  <span style="color:#a6e22e">res</span>[<span style="color:#ae81ff">2</span>] = <span style="color:#a6e22e">OprCfg</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;key3&#34;</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#e6db74">&#34;value3&#34;</span>, <span style="color:#a6e22e">Owner</span>: <span style="color:#e6db74">&#34;owener1&#34;</span>}
  <span style="color:#a6e22e">res</span>[<span style="color:#ae81ff">3</span>] = <span style="color:#a6e22e">OprCfg</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;key4&#34;</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#e6db74">&#34;value4&#34;</span>, <span style="color:#a6e22e">Owner</span>: <span style="color:#e6db74">&#34;owner1&#34;</span>}
  <span style="color:#a6e22e">res</span>[<span style="color:#ae81ff">4</span>] = <span style="color:#a6e22e">OprCfg</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;key7&#34;</span>, <span style="color:#a6e22e">Value</span>: <span style="color:#e6db74">&#34;value7&#34;</span>, <span style="color:#a6e22e">Owner</span>: <span style="color:#e6db74">&#34;owner1&#34;</span>}
  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">True</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">ObjectsAreEqual</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">res</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">opcfs</span>))
}
</code></pre></div><p>테스트 코드를 작성하기 위해서 “Test” 로 시작하는 함수명을 갖도록 했습니다.<br>
func Test_Config_New(t *testing.T) 함수에서 보면, 다음과 같은 주석을 볼 수 있습니다.</p>
<pre><code>// arrange
...
// act
...
// assert
...
</code></pre><p>이는 테스트 코드를 작성하기 위한 일종의 템플릿 같은것 입니다.<br>
arrange: 테스트를 진행하기 전에 필요한 준비 작업 정도의 코드들이 위치할 수 있습니다.
act: 실제로 테스트 되어서 결과를 확인하고자 하는 동작을 구현합니다.<br>
assert: act에서 진행한 동작에 대한 결과를 확인하는 용도입니다.</p>
<p>첫 번째 테스트 코드인 Test_Config_New는 Config 객체의 생성이 잘 되는지 확인하기 위한 테스트입니다.</p>
<p>arrange 절은 준비할 작업이 별도로 없기 때문에 생략 되었습니다.<br>
act 절에서 확인하고자 하는 NewConfig() 함수를 사용해서 Config 객체를 생성합니다.
assert 절에서 생성된 객체가 생성이 잘 되었는지 확인하는 과정으로 객체가 nil인지를 확인 합니다. 여기에서 testify/assert 패키지를 사용합니다.</p>
<p>assert 패키지에는 다양한 검증을 위한 기능을 제공하고 있습니다. 간단하게 assert.NotNil은 주어진 객체가 nil이 아닌지 확인하는 함수입니다. assert의 다양한 기능에 대해서는 godoc( <a href="https://godoc.org/github.com/stretchr/testify/assert">https://godoc.org/github.com/stretchr/testify/assert</a> ) 에서 확인해볼 수 있습니다.</p>
<p>두 번째 테스트 코드인 Test_GetOprCfg는 Config에  다양한 owner의 CfgItem들이 섞여 있는 중에서, 특정 owner와 onwer가 global로 지정된 CfgItem을 찾아서 OprCfg 만들어서 반환해주는걸 확인하기 위한 용도의 테스트입니다.</p>
<p>arrange 절에서 GetOprCfg 함수를 테스트하기 위해서 Config 객체를 생성해서 임의의 설정(CfgItem) 값들을 owner를 달리해서 입력(SetCfgItem) 합니다.<br>
act 절에서 GetOprCfg 함수에 owner로 &ldquo;owner1” 를 전달해서 OprCfg 슬라이스를 반환값으로 받습니다.<br>
assert 절에서는 결과 값으로 받은 OperCfg 슬라이스가 global과 owner1이 owner인 값들만을 전달받았는지를 확인합니다.</p>
<p>assert 패키지의 ObjectsAreEqual은 두 Object가 일치하는지를 확인합니다.<br>
assert 패키지의 True는 전달받은 값이 true인지를 확인합니다.</p>
<p>이렇게 기본적인 테스트 코드를 작성할 수 있습니다. 그렇지만 모든 상황에 대해서 테스트 코드를 작성할 수 있는 것은 아니며, 다음과 같은 경우에 대해서는 테스트 코드를 작성하는 데 한계가 있습니다.</p>
<ul>
<li>동시성 문제</li>
<li>접근제한자</li>
<li>GUI</li>
<li>의존성 모듈 테스트</li>
</ul>
<p>위의 경우는 고민하지 말고 테스트 코드 만들기를 포기하려고 합니다.</p>
<h2 id="테스트-코드-작성-예3">테스트 코드 작성 예(3)</h2>
<p>의존성의 경우는 테스트더블을 이용해서 어느 정도는 해결(?) 할 수 있다. 예를 들어 다음과 같은 경우입니다.</p>
<pre><code>패스워드 저장의 구현을 위해서 암호화 모듈을 제공 받아야 합니다. 
암호화를 위한 인터페이스와 암호화 방식이 미리 정해져 있다면, 암호화 모듈을 Mock으로 제작할 수 있습니다. 
미리 약속된 인터페이스 기능들을 Cipher라는 인터페이스로 정의하고 
그 인터페이스를 구현한 MockMD5Cipher를 만들어서 encrypt와 decrypt 내부에서 
“potato”와 potato의 md5 hash 값을 무조건 반환해 줍니다.
</code></pre><p>이러한 경우를 우리 프로젝트에서 생각해 보면 MessageQueue에 의존적인 환경에서 개발하고 있는걸 생각해 볼 수 있습니다. MessageQueue의 동작을 테스트더블 객체로 만들어서 테스트 코드를 작성해 볼 수 있습니다.</p>
<p>&ldquo;테스트더블&rdquo; 이라는 용어는 대역, 스턴트맨을 의미하는 스턴트 더블이라는 단어에서 유래되었습니다.<br>
데스트더블의 분류에는 &ldquo;Dummy&rdquo;, &ldquo;Stub&rdquo;, &ldquo;Fake&rdquo;, &ldquo;Spy&rdquo;, &ldquo;Mock&rdquo; 이 있다. 이들의 정의 또는 쓰임새는 다음과 같습니다.</p>
<ul>
<li>Dummy: 객체의 겉모양만 만들어서 테스트를 진행할 수 있도록 하는 목적의 객체입니다. (객체가 생성만 되면 되는 경우에 사용합니다)</li>
<li>Stub: 특정 메소드가 호출되어야 정상적인 동작이 가능한 경우에 사용하는 객체입니다.(객체가 특정 상태나 모습을 갖추면 되기 때문에 필요한 메소드에 하드 코딩으로 결과 값 등을 작성합니다.)</li>
<li>Fake: 여러 상황을 대표하기 위해 Stub보다 좀 더 복잡한 구현이 들어간 객체입니다.</li>
<li>Spy: 특정한 메소드가 호출되었는지 확인하기 위한 용도로 호출된 내역을 내부에서 기록하는 로직이 들어갑니다.</li>
<li>Mock: 위의 테스트더블 객체들은 상태에 대한 확인이 주된 용도였다면 Mock은 행위를 검증하는 용도로 많이 사용됩니다.</li>
</ul>
<p>이제 MessageQueue에 의존적인 부분을 테스트더블 객체로 만들어서 테스트 코드를 작성해 보려고 합니다.<br>
변경된 이벤트 정보를 확인하는 GetChangeEventInfo 함수에 대한 테스트 코드를 작성해 보겠습니다.<br>
테스트 코드를 작성하고자 하는 전체 로직은 다음과 같습니다.</p>
<ol>
<li>GetChangeEventInfo 함수가 호출되는 경우는 외부에서 이벤트가 변경되었음을 알리는 요청이 들어 옵니다.</li>
<li>전달받은 eventID 값을 이용해서 GetChangeEventInfo 함수가 MessageQueue에 연결되어 있는 Agent에게 변경된 이벤트 정보를 전달해 달라고 요청합니다.</li>
<li>Agent는 Database에서 조회해서 MessageQueue에 결과를 전달할것 입니다.</li>
<li>sample_1은 MessageQueue를 통해서 전달된 응답을 수집할것 입니다.</li>
<li>결과로 받은 값을 확인 합니다.</li>
</ol>
<p>테스트 코드를 작성하기 이전의 코드 상태는 다음과 같았습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">GetChangeEventInfo</span>(<span style="color:#a6e22e">eventID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">EventInfo</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#f92672">*</span><span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MakeChangeMsg</span>(<span style="color:#960050;background-color:#1e0010">“</span><span style="color:#a6e22e">blah</span><span style="color:#f92672">-</span><span style="color:#a6e22e">blah</span><span style="color:#f92672">-</span><span style="color:#a6e22e">chg</span><span style="color:#f92672">-</span><span style="color:#a6e22e">key</span><span style="color:#960050;background-color:#1e0010">”</span>, <span style="color:#960050;background-color:#1e0010">“</span><span style="color:#a6e22e">agent</span><span style="color:#960050;background-color:#1e0010">”</span>)<span style="color:#f92672">*</span>
 
  <span style="color:#a6e22e">eventUUID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UUID_Data</span> { <span style="color:#a6e22e">UUID</span>: <span style="color:#a6e22e">eventID</span> }
  <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Encoding</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">eventUUID</span>)
  <span style="color:#f92672">*</span><span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Payload</span>(<span style="color:#a6e22e">any</span>)
 
  <span style="color:#75715e">/* message queue 관련 기타 등등의 구현 들
</span><span style="color:#75715e">      ...
</span><span style="color:#75715e">  */</span>
 
  <span style="color:#a6e22e">SendMessage</span>(<span style="color:#a6e22e">msg</span>)
  <span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">RecvMessage</span>()

  <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">val</span>.<span style="color:#a6e22e">GetPayload</span>()
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ei</span> <span style="color:#a6e22e">EventInfo</span>
  <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Decoding</span>(<span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ei</span>)
 
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ei</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>위의 코드 중에서 굵게 표시된 부분은 sample_1 이 아닌 외부 요소(MessageQueue)들에 대한 동작을 구현한 부분입니다.<br>
그리고 이 부분은 MessageQueue에 무언가를 요청하는 과정에서 매번 반복되기도 합니다. 그래서 이 부분을 별도의 함수로 구현하기로 했습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">GetChangeEventInfo</span>(<span style="color:#a6e22e">eventID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">EventInfo</span>, <span style="color:#66d9ef">error</span>) { 
  <span style="color:#a6e22e">sendInfo</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MqSendInfo</span>{
    <span style="color:#a6e22e">key</span>:     <span style="color:#960050;background-color:#1e0010">“</span><span style="color:#a6e22e">blah</span><span style="color:#f92672">-</span><span style="color:#a6e22e">blah</span><span style="color:#f92672">-</span><span style="color:#a6e22e">chg</span><span style="color:#f92672">-</span><span style="color:#a6e22e">key</span><span style="color:#960050;background-color:#1e0010">”</span>,
    <span style="color:#a6e22e">recv</span>: <span style="color:#960050;background-color:#1e0010">“</span><span style="color:#a6e22e">agent</span><span style="color:#960050;background-color:#1e0010">”</span>,
  }
 
  <span style="color:#a6e22e">eventUUID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UUID_Data</span>{ <span style="color:#a6e22e">UUID</span>: <span style="color:#a6e22e">eventID</span> }
  <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Encoding</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">eventUUID</span>)
 
  <span style="color:#a6e22e">anyData</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MqSend</span>(<span style="color:#a6e22e">sendInfo</span>, <span style="color:#a6e22e">any</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> { <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span> }
 
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ei</span> <span style="color:#a6e22e">EventInfo</span>
  <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Decoding</span>(<span style="color:#a6e22e">anyData</span>[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ei</span>)

  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ei</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>위와 같이 코드를 별도의 함수(MqSend)로 빼놓고, MqSendInfo라는 struct를 인자로 받도록 변경을 했습니다. 함수와 구조체는 다음과 같이 작성 되었습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MqSendInfo</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">key</span>     <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">recv</span> <span style="color:#66d9ef">string</span>
}
 
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MqSend</span>(<span style="color:#a6e22e">info</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MqSendInfo</span>, <span style="color:#a6e22e">any</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MakeChangeMsg</span>(<span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">recv</span>)
  
  <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Payload</span>(<span style="color:#a6e22e">any</span>)
 
  <span style="color:#75715e">/* message queue 관련 기타 등등의 구현 들 
</span><span style="color:#75715e">     ...
</span><span style="color:#75715e">  */</span>
 
  <span style="color:#a6e22e">SendMessage</span>(<span style="color:#a6e22e">msg</span>) 
  <span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">RecvMessage</span>()
 
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">val</span>.<span style="color:#a6e22e">Msgs</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>이렇게 해서 중복된 코드를 많이 줄일 수는 있었습니다. 그렇지만 MessageQueue의 의존성은 여전히 남아 있습니다.</p>
<p>테스트 코드를 작성하는 입장에서는 우리가 전달한 eventID의 값을 이용해서 MqSend 함수가 EventInfo 값을 돌려주면됩니다. MqSend가 호출되었는지와 그 함수의 결과 값을 이용해서 GetChangeEventInfo가 우리가 원하는 결과 값을 만들어서 돌려주면 성공적으로 동작한 걸로 간주할 수가 있게 됩니다.</p>
<p>그래서 MqSend 함수를 가짜로 구현하고 있는 테스트더블 객체를 만들려고 합니다. +
우선 위의 MqSendInfo 구조체와 MqSend 함수의 이름을 MqMsg 구조체와 구조체의 메소드 Send로 변경하였습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Messenger</span> <span style="color:#66d9ef">interface</span> {
  <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">any</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>, <span style="color:#66d9ef">error</span>)
}
 
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MqMsg</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">key</span>     <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">recv</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MqMsg</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">any</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MakeChangeMsg</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">recv</span>)
 
  <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Payload</span>(<span style="color:#a6e22e">any</span>)
 
  <span style="color:#75715e">/* message queue 관련 기타 등등의 구현 들 
</span><span style="color:#75715e">     ...
</span><span style="color:#75715e">  */</span>
 
  <span style="color:#a6e22e">SendMessage</span>(<span style="color:#a6e22e">msg</span>)
  <span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">RecvMessage</span>()

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">val</span>.<span style="color:#a6e22e">Msgs</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>이제 테스트 코드를 다음과 같이 작성해 볼 수 있습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MockAgentMsgr</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">Mock</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockAgentMsgr</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">any</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Called</span>(<span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">wait</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#ae81ff">0</span>).([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>), <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#ae81ff">1</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Test_GetChangeEventInfo</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
  <span style="color:#75715e">// arrange
</span><span style="color:#75715e"></span> 
  <span style="color:#75715e">// 입력 값
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">eventID</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;event--uuid-1&#34;</span>
 
  <span style="color:#a6e22e">UUID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UUID_Data</span> { <span style="color:#a6e22e">UUID</span>: <span style="color:#a6e22e">eventID</span> }
  <span style="color:#a6e22e">par1</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Encoding</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UUID</span>)
 
  <span style="color:#75715e">// 출력 값
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resAnytypes</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Any</span>
  <span style="color:#a6e22e">res1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">EventInfo</span> { <span style="color:#a6e22e">UUID</span>: <span style="color:#a6e22e">eventID</span>, <span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;event1&#34;</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">ET_START</span> }
 
  <span style="color:#a6e22e">resAnytype1</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Encoding</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">res1</span>)
  <span style="color:#a6e22e">resAnytypes</span> = append(<span style="color:#a6e22e">resAnytypes</span>, <span style="color:#a6e22e">resAnytype1</span>)
 
  <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MockAgentMsgr</span>{}
  <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Send&#34;</span>, <span style="color:#a6e22e">par1</span>).<span style="color:#a6e22e">Return</span>(<span style="color:#a6e22e">resAnytypes</span>, <span style="color:#66d9ef">nil</span>)
 
  <span style="color:#a6e22e">agentMg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewAgent</span>(<span style="color:#a6e22e">m</span>)
 
  <span style="color:#75715e">// act
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">event</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">agentMg</span>.<span style="color:#a6e22e">GetChangeEventInfo</span>(<span style="color:#a6e22e">eventID</span>)
 
  <span style="color:#75715e">// assert
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>)
  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">True</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">ObjectsAreEqual</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">res1</span>, <span style="color:#a6e22e">event</span>))
  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">True</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">AssertCalled</span>(<span style="color:#a6e22e">t</span>, <span style="color:#e6db74">&#34;Send&#34;</span>, <span style="color:#a6e22e">par1</span>, <span style="color:#66d9ef">true</span>))
}
</code></pre></div><p>MqMsg의 테스트더블을 구현하기 위해서 Messenger 인터페이스에 Send 메소드를 정의했습니다.<br>
MockAgentMsgr 구조체는 Messenger 인터페이스를 구현한 테스트더블 입니다.<br>
MockAgentMsgr의 Send 메소드의 구현에서는 입력된 값과 반환되어야 할 값에 대해서 지정을 하고 있습니다.<br>
이제 Test_GetChangeEventInfo 함수에서 입력값을 만들고 Send 메소드가 호출되었을 때 반환해야 할 출력값도 지정 합니다. MessageQueue에서 어떤 동작을 하든지 상관없이 입력된 값에 의해서 정해진 결과 값을 받는다는 가정 입니다. 그래서 작성된 코드 중에 다음과 같은 내용이 있습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MockAgentMsgr</span>{}
<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">On</span>(<span style="color:#e6db74">&#34;Send&#34;</span>, <span style="color:#a6e22e">par1</span>).<span style="color:#a6e22e">Return</span>(<span style="color:#a6e22e">resAnytypes</span>, <span style="color:#66d9ef">nil</span>)
</code></pre></div><p>Send 메소드가 호출될 때 입력값에 대해서 출력값을 정의해 놓은것 입니다.</p>
<p>그런데 현재의 실행 코드상에서는 정해진 형태(MqMsg의 Send 메소드)만을 호출하는 구조입니다. 이를 변경해야 할 필요가 있습니다. 그래서 우리는 Agent 객체를 생성하는 시점에 MessageQueue에 대한 정보를 지정해서 받는 형식으로 변경 했습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Agent</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">Msgr</span> <span style="color:#a6e22e">Messenger</span>
}
 
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewAgent</span>(<span style="color:#a6e22e">msgr</span> <span style="color:#a6e22e">Messenger</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span> {
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Agent</span>{<span style="color:#a6e22e">Msgr</span>: <span style="color:#a6e22e">msgr</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Agent</span>) <span style="color:#a6e22e">GetChangeEventInfo</span>(<span style="color:#a6e22e">eventID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">EventInfo</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">eventUUID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UUID_Data</span>{ <span style="color:#a6e22e">UUID</span>: <span style="color:#a6e22e">evnetID</span> }
  <span style="color:#a6e22e">any</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Encoding</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">eventUUID</span>)
 
  <span style="color:#a6e22e">anyData</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Msgr</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">any</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> { <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span> }
 
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ei</span> <span style="color:#a6e22e">EventInfo</span>
  <span style="color:#a6e22e">Any</span>.<span style="color:#a6e22e">Decoding</span>(<span style="color:#a6e22e">anyData</span>[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ei</span>)
 
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ei</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>이제 테스트 코드에서처럼 NewAgent로 Agent 객체를 생성하기 전에 Messenger를 생성해서 전달받을 수 있게 되었습니다. (단, 실제로 Agent를 사용하는 시점에서는 매번 중복 코드가 발생하게 되었습니다. 이 부분은 다음에 다시 개선하기로 합니다.)</p>
<p>이제 GetChangeEventInfo 함수를 구현하기 위해서 MessageQueue에 연결해서 디버깅하기 위한 과정 대신에 테스트 코드가 sample_1 에서 구현되어야 할 내용에 대해서 보장을 해줄 수 있게 되었습니다.</p>
<h2 id="결론">결론</h2>
<p>이제 입력되는 값과 MessageQueue 건너편의 대상으로부터 받기를 원하는 값에 대한 정의만 정확하다면, MessageQueue에 직접 연결되지 않아도 우리는 sample_1 의 기능을 구현할 수 있게 되었습니다.<br>
그리고 코딩 중에 세워졌던 원칙에 어긋나는 경우에 대해서 별도의 문서나 히스토리를 확인하지 않고 작성된 테스트 코드로 확인할 수 있게 되었습니다.</p>

					</div>
				</article>

			</div>
		</div> 

		<div class="row">
			<div class="col-sm-8 col-sm-offset-2">

				<div id="share">
					
				</div>
			</div>
		</div> 
		<div class="clearfix"></div>

		<div class="row">
			<div class="col-sm-8 col-sm-offset-2">

				<div id="comments">
					
				</div>
			</div>
		</div> 
		<div class="clearfix"></div>

	</div>	

</main>

    
    
      <footer id="footer">
	<div class="container">
		<div class="row">
			

			
			<div class="col-md-3 widget">
				<h3 class="widget-title">Follow me</h3>
				<div class="widget-body">
					<p class="follow-me-icons">
            
							
								<a href="https://www.facebook.com/jaehoon" target="_blank"><i class="fab fa-facebook-square fa-1x"></i></a>
							
            
							
								<a href="https://twitter.com/jaehoonn_" target="_blank"><i class="fab fa-twitter-square fa-1x"></i></a>
							
            
							
								<a href="https://github.com/jaehoonn" target="_blank"><i class="fab fa-github fa-1x"></i></a>
							
            
							
								<a href="mailto:jaehoon@shrinklabs.com" target="_blank"><i class="fas fa-envelope-square fa-1x"></i></a>
							
            
					</p>
				</div>
			</div>
			

			

			

		</div> 
	</div>
</footer>

<footer id="underfooter">
	<div class="container">
		<div class="row">

			<div class="col-md-6 widget">
				<div class="widget-body">
					<p></p>
				</div>
			</div>

			<div class="col-md-6 widget">
				<div class="widget-body">
					<p class="text-right">
						Copyright &copy; 2021, <br>
						Design: <a href="http://www.gettemplate.com" rel="designer">Initio by GetTemplate</a> - 
						Powered by: <a href="https://gohugo.io/" rel="poweredby">Hugo</a>
					</p>
				</div>
			</div>

		</div> 
	</div>
</footer>




<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>




<script src="https://shrinklabs.com/post/js/bundle.min.b4d4f6818b4e26d94fb4399ccecba55248c6c39b666a474da4289f5f9dd5de310f550d6db5ab597255174ef0acf2fd488c3e5d92f0cabc10600c94b70c601f28.js" integrity="sha512-tNT2gYtOJtlPtDmczsulUkjGw5tmakdNpCifX53V3jEPVQ1ttatZclUXTvCs8v1IjD5dkvDKvBBgDJS3DGAfKA=="></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'G-4LRCTZDF74', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>

    
  </body>
  
</html>