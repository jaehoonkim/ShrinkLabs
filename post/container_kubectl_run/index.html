<!DOCTYPE html>
<html lang="en">
    <head>
		
		
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Windows기반의 minikube로 로컬 환경의 image 사용해서 배포하기 &middot; ShrinkLabs</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="ShrinkLabs" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">ShrinkLabs</h2>
				</a>
				<ul>
    
    
        <li>
            <a href="/about/">
                
                <span>about</span>
                
            </a>
        </li>
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2020-05-19 01:05:57 &#43;0900 KST">May 19, 2020</time>
</div>

		<h1 class="post-title">Windows기반의 minikube로 로컬 환경의 image 사용해서 배포하기</h1>
<div class="post-line"></div>

		

		<p>실제 클러스터에 배포하기 전에 로컬 환경의 minikube를 이용해서 배포하고 테스트를 하기 위한 방법이 필요하면 다음과 같이 합니다.</p>
<p>minikube를 시작하고, minikube에 내장되어 있는 docker 데몬을 사용하도록 합니다. 이렇게 하면 호스트 머신의 Docker Registry를 사용하고 image도 호스트 머신에 생성해 놓은 것을 사용할 수 있습니다.<br>
(<a href="https://kubernetes.io/docs/setup/learning-environment/minikube/#use-local-images-by-re-using-the-docker-daemon">https://kubernetes.io/docs/setup/learning-environment/minikube/#use-local-images-by-re-using-the-docker-daemon</a>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; minikube docker-env
$Env:DOCKER_TLS_VERIFY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1&#34;</span>
$Env:DOCKER_HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tcp://192.168.182.22:2376&#34;</span>
$Env:DOCKER_CERT_PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;C:\Users\jaehoonn\.minikube\certs&#34;</span>
<span style="color:#75715e"># Run this command to configure your shell:</span>
<span style="color:#75715e"># &amp; minikube docker-env | Invoke-Expression</span>

PS&gt; minikube docker-env | Invoke-Expression
</code></pre></div><p>이렇게 하면, minikube vm 안에 존재하는 docker 데몬과 통신을 하게 됩니다.</p>
<p>이제 만들어 놓은 이미지를 실행합니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn run sample-app --image<span style="color:#f92672">=</span>sample-app:latest --port<span style="color:#f92672">=</span><span style="color:#ae81ff">9000</span> --serviceaccount<span style="color:#f92672">=</span>jaehoonn-controller 
</code></pre></div><p>다음과 같이 배포가 된 것을 확인 할 수 있습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn get pods
NAME                             READY   STATUS              RESTARTS   AGE
sample-app-685bbd44c6-kgc4z      1/1     Running   <span style="color:#ae81ff">0</span>          5h24m
</code></pre></div><p>웹브라우저를 통해서 연결 상태를 확인하기 위해서 Service를 생성합니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn expose deployment sample-app --type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;LoadBalancer&#34;</span>
</code></pre></div><p>생성된 Service를 확인하면, 다음과 같이 pending 상태이다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn get services
NAME             TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>          AGE
sample-app       LoadBalancer   10.102.191.6   &lt;pending&gt;     8500:32416/TCP   11s
</code></pre></div><p>이제 minikube를 통해서 url을 생성합니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; minikube -n jaehoonn service sample-app --url
* http://192.168.182.22:32416
</code></pre></div><p>필요한 테스트 작업을 완료하고 난 다음 해당 이미지를 중지하고자 할 때,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn delete pods/sample-app-685bbd44c6-kgc4z
pod <span style="color:#e6db74">&#34;sample-app-685bbd44c6-kgc4z&#34;</span> deleted
</code></pre></div><p>삭제 되었다는 메세지가 나오지만 실제로는 삭제 되지 않습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn get pod
NAME                             READY   STATUS              RESTARTS   AGE
sample-app-685bbd44c6-kgc4z      1/1     Running             <span style="color:#ae81ff">0</span>          5h24m
</code></pre></div><p>모든 리소스를 조회해보면 다음과 같습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn get all
NAME                                 READY   STATUS              RESTARTS   AGE
pod/sample-app-685bbd44c6-fxl8f      1/1     Running             <span style="color:#ae81ff">0</span>          7m3s




NAME                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/sample-app      1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">0</span>           5h36m

NAME                                       DESIRED   CURRENT   READY   AGE
replicaset.apps/sample-app-685bbd44c6      <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">0</span>       5h36m
</code></pre></div><p>여기에서 deployment를 삭제하면 관련된 모든 리소스가 삭제됩니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn delete deployment/sample-app
deployment.extensions <span style="color:#e6db74">&#34;discovery&#34;</span> deleted
</code></pre></div><p>다시 모든 리소스를 조회해보면 다음과 같이 모두 삭제된 걸 확인할 수 있습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PS&gt; kubectl -n jaehoonn get all

No resources found.
</code></pre></div><p>이 작업으로 Service까지 삭제 되지는 않습니다.</p>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-8444244371421612"
     data-ad-slot="6693872766"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


		
	</div>

	<div class="pagination">
		<a href="/post/go_crosscompile_on_windows/" class="left arrow">&#8592;</a>
		<a href="/post/git_upstream/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2021-07-22 01:15:01.98337789 &#43;0900 KST m=&#43;0.039333034">2021</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
